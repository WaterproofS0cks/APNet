{% extends "layout.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}
<body>
    <div class="content-card">
        <div class="card-header">
            <h2>Dashboard</h2>
        </div>

        <div class="card-filter">
            <form action="/dashboard" method="POST">
                <div>
                    <label for="filter">Filter by:</label>
                    <select name="filter" id="filter" required>
                        <option value="days" {% if filter_value == 'days' %}selected{% endif %}>Days</option>
                        <option value="months" {% if filter_value == 'months' %}selected{% endif %}>Months</option>
                        <option value="years" {% if filter_value == 'years' %}selected{% endif %}>Years</option>
                        <option value="all-time" {% if filter_value == 'all-time' %}selected{% endif %}>All Time</option>
                    </select>
                </div>
                <div>
                    <label for="range">Range:</label>
                    <input type="text" id="range" name="range" value="{{ range_value }}" required>
                </div>
                <input type="submit" value="Filter" id="filter-button">
            </form>
        </div>

        <hr>

        <div class="card-section">
            <div class="dashboard-wrap">
                <div class="dashboard-row">
                    <h2>Overview</h2>
                </div>
                <div class="dashboard-row">
                    <p>General</p>
                    <div class="dashboard-column-sm">
                        <div class="dashboard-card">
                            <h3>Users</h3>
                            <h1>{{ user_count }}</h1>
                        </div>
                    </div>
                    <div class="dashboard-column-sm">
                        <div class="dashboard-card">
                            <h3>Posts</h3>
                            <h1>{{ post_count }}</h1>
                        </div>
                    </div>
                </div>
                <div class="dashboard-row">
                    <p>Moderation</p>
                    <div class="dashboard-column-sm">
                        <div class="dashboard-card">
                            <h3>Banned Users</h3>
                            <h1>{{ banned_count }}</h1>
                        </div>
                    </div>
                    <div class="dashboard-column-sm">
                        <div class="dashboard-card">
                            <h3>Muted Users</h3>
                            <h1>{{ muted_count }}</h1>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="card-section">
            <div class="dashboard-wrap">
                <div class="dashboard-row">
                    <h2>Charts</h2>
                    <div class="dashboard-column-lg">
                        <div class="dashboard-card">
                            <div id="chart-container">
                            {{ chart|safe }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        $('.button-filter').click(function() {
            $(this).toggleClass('focus');
        });
    </script>

    <!-- For my own sanity and not to break things okay? -->
    <script>
        document.getElementById('filter-form').addEventListener('submit', function(event) {
            event.preventDefault();

            var filterValue = document.getElementById('filter').value;
            var rangeValue = document.getElementById('range').value;

            var formData = new FormData();
            formData.append('filter', filterValue);
            formData.append('range', rangeValue);

            fetch('/dashboard', {
                method: 'POST',
                body: formData
            })
            .then(function(response) {
                return response.json();
            })
            .then(function(data) {
                console.log('Chart update data:', data); 
                document.getElementById('chart-container').innerHTML = data.chart; 
            })
            .catch(function(error) {
                console.error('Error updating chart:', error); 
            });
        });

    </script>
</body>
{% endblock %}
